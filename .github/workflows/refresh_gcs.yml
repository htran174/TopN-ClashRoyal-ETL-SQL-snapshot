name: refresh-gcs

on:
  workflow_dispatch:
    inputs:
      topn:
        description: "Top N players"
        required: false
        default: "1000"
  schedule:
    - cron: "0 9 * * 1" # Mondays 09:00 UTC
  pull_request:
    branches: [ "main" ]

jobs:
  # PR smoke test (NO GCS upload). Only runs if PR is NOT from a fork (secrets available).
  pr-smoke:
    if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: clash
          POSTGRES_PASSWORD: clash
          POSTGRES_DB: clash
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U clash -d clash"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=20

    env:
      PGHOST: localhost
      PGPORT: "5432"
      PGUSER: clash
      PGPASSWORD: clash
      PGDATABASE: clash
      DATABASE_URL: postgresql://clash:clash@localhost:5432/clash

      CR_API_TOKEN: ${{ secrets.CR_API_TOKEN }}
      TOPN: "20"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install system deps (psql/pg_dump)
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Apply schema
        run: |
          psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -f db/schema.sql

      - name: Run ETL (TOPN=20)
        run: |
          python -m scripts.etl_snapshot_topn --top-n "$TOPN"

      - name: Run validate (TOPN=20)
        run: |
          python -m scripts.validate_snapshot --top-n "$TOPN"

  # Real scheduled/manual refresh + export + upload to GCS
  refresh-and-upload:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: clash
          POSTGRES_PASSWORD: clash
          POSTGRES_DB: clash
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U clash -d clash"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=20

    env:
      PGHOST: localhost
      PGPORT: "5432"
      PGUSER: clash
      PGPASSWORD: clash
      PGDATABASE: clash
      DATABASE_URL: postgresql://clash:clash@localhost:5432/clash

      CR_API_TOKEN: ${{ secrets.CR_API_TOKEN }}

      TOPN: ${{ github.event.inputs.topn || '1000' }}

      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      GCS_BUCKET_NAME: ${{ secrets.GCS_BUCKET_NAME }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install system deps (psql/pg_dump)
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Apply schema
        run: |
          psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -f db/schema.sql

      - name: Run ETL (TOPN)
        run: |
          python -m scripts.etl_snapshot_topn --top-n "$TOPN"

      - name: Run validate (TOPN)
        run: |
          python -m scripts.validate_snapshot --top-n "$TOPN"

      - name: Export snapshot (pg_dump -> exports/)
        run: |
          chmod +x scripts/export_snapshot.sh
          scripts/export_snapshot.sh

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Upload artifacts to GCS (latest + dated run folder)
        run: |
          RUN_DATE="$(date -u +%Y-%m-%d)"
          LATEST_PATH="gs://${GCS_BUCKET_NAME}/clash-meta/latest"
          RUN_PATH="gs://${GCS_BUCKET_NAME}/clash-meta/runs/${RUN_DATE}"

          echo "Uploading to:"
          echo "  ${LATEST_PATH}/"
          echo "  ${RUN_PATH}/"

          gsutil -m cp -r exports/* "${LATEST_PATH}/"
          gsutil -m cp -r exports/* "${RUN_PATH}/"
